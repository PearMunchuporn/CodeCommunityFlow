@model List<CodeCommunityFlow.ViewModels.UserViewModel>

<h4 class="my-4">Users</h4>

<div id="userTableWrapper">
    <table id="usersTable" class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>User ID</th>
                <th>User Name</th>
                <th>Score</th>
                <th>Direct Message</th>
                <th>Warning Count</th>
                <th>Warning Message</th>
                <th>Delete User</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var user in Model)
            {
                <tr data-user-id="@user.UserID">
                    <td  style="text-align: center; justify-content: center; vertical-align: middle;">@user.UserID</td>
                    <td  style="text-align: center; justify-content: center; vertical-align: middle;"><b><a href="@Url.Action("UserViewProfile", "UserViewProfile", new { id = @user.UserID })">@user.UserName</a></b></td>
                    <td   style="text-align: center; justify-content: center; vertical-align: middle;" >@user.Score</td>
                    <td  style="text-align: center; justify-content: center; vertical-align: middle;">
                        <button class="btn" data-toggle="modal"
                                data-target="#WarningModalDM"
                                data-user-id="@user.UserID"
                                data-username="@user.UserName"
                                data-warningmessage="@user.WarningMessage">
                            <i class="bi bi-envelope-fill text-warning" style="font-size:1.5rem;"></i>
                        </button>
                    </td>

                 
                    <td   style="text-align: center; justify-content: center; vertical-align: middle;"><span id="warningCount-@user.UserID">@user.WarningCount</span></td>
                    <td style="vertical-align:middle;"><span id="warningMsg-@user.UserID">@user.WarningMessage</span></td>

                    <td>
                        <button style="display: block; margin:auto; padding:7px; font-size:1rem; font-weight:600;" type="button" class="btn btn-danger"
                                data-toggle="modal"
                                data-target="#deleteUserModal"
                                data-userid="@user.UserID"
                                data-username="@user.UserName">
                            Delete User
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this user?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <a id="confirmDeleteBtn" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>

<!-- Warning Message Modal -->
<div class="modal fade" id="WarningModalDM" tabindex="-1" role="dialog" aria-labelledby="WarningModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">Direct Message To User</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="warningUserId" />
                <p><b>Direct Message To: <span id="warningUserName"></span></b></p>
                <textarea rows="5" class="form-control" id="WarningMessageModal" name="WarningMessage"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button id="SendMsgBtn" class="btn btn-primary">Submit Message</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Base style */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.875rem !important;
        margin: 0;
        border-radius: 0.25rem !important;
        color: #007bff !important;
        background: transparent !important;
        border: 1px solid transparent;
    }

        /* Current page */
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #007bff !important;
            color: #fff !important;
            border: 1px solid transparent;
        }

        /* Hover state override */
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover,
        .dataTables_wrapper .dataTables_paginate .paginate_button:active,
        .dataTables_wrapper .dataTables_paginate .paginate_button:focus {
            background-color: #e2e6ea !important; /* Light gray */
            color: #007bff !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: none !important;
        }
</style>



<!-- ✅ DataTables Core -->
<script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>

<!-- ✅ DataTables Bootstrap 4 Integration -->
<script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>

<script>
    function bindDeleteAndWarningModal() {
        $('[data-target="#deleteUserModal"]').off('click').on('click', function () {
            var uId = $(this).data('userid');
            var deleteUrl = '/UserManagement/DeleteUserByAdmin/' + uId;
            $('#confirmDeleteBtn').attr('href', deleteUrl);
        });

        $('[data-target="#WarningModalDM"]').off('click').on('click', function () {
            var userId = $(this).data('user-id');
            var userName = $(this).data('username');
            var warning = $(this).data('warningmessage');
            $('#warningUserId').val(userId);
            $('#warningUserName').text(userName);
            $("#WarningMessageModal").text(warning);
        });
    }

    function initializeDataTable() {
        $('#usersTable').DataTable({
            paging: true,
            ordering: true,
            info: true,
            pagingType: "full_numbers",
            destroy: true,
            columnDefs: [{ orderable: false, targets: [5] }],
            drawCallback: function () {
                bindDeleteAndWarningModal();
            }
        });
    }

    $(document).ready(function () {
        initializeDataTable();
        bindDeleteAndWarningModal();

   $("#SendMsgBtn").click(function () {
    const userId = $("#warningUserId").val();
    const message = $("#WarningMessageModal").val();

    if (!message.trim()) {
        alert("Please enter message.");
        return;
    }

    $.ajax({
        type: "POST",
        url: '@Url.Action("SentMessageToUser", "UserManagement")',
        data: {
            UserID: userId,
            WarningMessage: message
        },
        success: function () {
            $('#WarningModalDM').modal('hide');

            setTimeout(function () {
                location.reload(); // ✅ Full page refresh to show updated data
            }, 10);
        },
        error: function () {
            alert("An error occurred while sending the message.");
        }
    });

        });
    });
</script>
